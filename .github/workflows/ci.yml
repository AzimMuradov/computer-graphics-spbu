name: CI

on:
  workflow_dispatch:
  push:
  pull_request:
    branches: [ main ]

jobs:
  python:
    needs: c
    runs-on:
      - ubuntu-latest
      - macos-latest
      - windows-latest
    strategy:
      matrix:
        python-version: [ "3.10", "3.11" ]

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
      - name: "Set up Python ${{ matrix.python-version }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: "Install dependencies"
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: "Check python code formating with black"
        run: |
          pip install black
          black --check .
      - name: "Check python code with mypy"
        run: |
          pip install mypy
          mypy .

  c:
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
      - name: "Build c code using gcc"
        run: >
          gcc
          -shared
          -o backend/libbackend.so
          -Wall -pedantic -Wextra -Werror
          -O3 -fPIC -ffast-math
          backend/library.c
